<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Foto ‚Äî Retratos de Bonito</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
  <header class="bg-white border-b border-gray-200 sticky top-0 z-40">
    <div class="container mx-auto px-4 py-4 flex items-center justify-between">
      <h1 class="text-2xl font-bold text-gray-900">üì∏ Retratos de Bonito</h1>
      <nav class="space-x-4">
        <a href="/" class="text-gray-700 hover:text-gray-900">Home</a>
        <a href="/search.html" class="text-gray-700 hover:text-gray-900">Buscar</a>
      </nav>
    </div>
  </header>

  <main class="container mx-auto px-4 py-8">
    <a href="/" class="text-blue-600 hover:underline mb-4 inline-block">‚Üê Voltar</a>
    <div id="content" class="bg-white rounded-lg p-6">Carregando...</div>
  </main>

  <div id="downloadModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 max-w-lg w-full mx-4">
      <h3 class="font-semibold text-lg mb-3">Termo de Uso ‚Äî Download de Imagem</h3>
      <div class="bg-gray-50 p-4 rounded mb-4 text-sm text-gray-700 max-h-40 overflow-y-auto">
        <p class="mb-2"><strong>Cr√©dito:</strong> Ao usar esta imagem, cite "Retratos de Bonito" e o arquivo comunit√°rio.</p>
        <p class="mb-2"><strong>Uso Comercial:</strong> Requer autoriza√ß√£o expl√≠cita dos curadores.</p>
        <p><strong>Direitos de Imagem:</strong> Respeitar a privacidade das pessoas fotografadas.</p>
      </div>
      <label class="flex items-center mb-4">
        <input type="checkbox" id="agreeCheckbox" class="mr-2" />
        <span class="text-sm">Li e concordo com os termos acima</span>
      </label>
      <div class="flex gap-3">
        <button onclick="closeDownloadModal()" class="px-4 py-2 border rounded hover:bg-gray-50">Cancelar</button>
        <button onclick="confirmDownload()" id="confirmBtn" disabled class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed">Baixar</button>
      </div>
    </div>
  </div>

  <script src="/api.js"></script>
  <script>
    const photoId = new URLSearchParams(location.search).get('id')
    let currentPhoto = null

    async function load() {
      try {
        const photo = await getPhotoDetail(photoId)
        const stories = await getPhotoStories(photoId)
        currentPhoto = photo
        render(photo, stories)
      } catch (e) {
        document.getElementById('content').innerHTML = '<div class="text-red-600">Erro ao carregar: ' + e.message + '</div>'
      }
    }

    function render(photo, stories) {
      const html = `
        <div class="space-y-6">
          <div>
            <img src="${API}/${encodeURIComponent(photo.file_name)}" alt="${photo.description}" class="w-full rounded-lg mb-4" />
            <h1 class="text-3xl font-bold mb-2">${photo.description || 'Foto sem descri√ß√£o'}</h1>
            <p class="text-gray-600">${photo.location||'Local desconhecido'} ‚Ä¢ ${photo.decade?photo.decade+'s':'sem data'}</p>
            ${photo.source ? '<p class="text-sm text-gray-500">Acervo: ' + photo.source + '</p>' : ''}
          </div>

          ${photo.people && photo.people.length > 0 ? `
            <section>
              <h2 class="text-xl font-semibold mb-3">Pessoas na Foto</h2>
              <div class="flex flex-wrap gap-2">
                ${photo.people.map(p => `
                  <span class="bg-blue-100 text-blue-900 px-3 py-1 rounded-full text-sm">
                    <strong>${p.full_name}</strong>${p.nickname ? ' ("' + p.nickname + '")' : ''} ‚Äî ${p.role||'sem fun√ß√£o'}
                  </span>
                `).join('')}
              </div>
            </section>
          ` : ''}

          ${stories && stories.length > 0 ? `
            <section>
              <h2 class="text-xl font-semibold mb-3">Hist√≥rias & Depoimentos</h2>
              <div class="space-y-4">
                ${stories.map(s => `
                  <article class="border-l-4 border-green-600 pl-4 py-2">
                    <h3 class="font-semibold text-gray-900">${s.title}</h3>
                    <p class="text-gray-700 mt-1">${s.content}</p>
                    ${s.author_name ? '<p class="text-xs text-gray-500 mt-2">‚Äî ' + s.author_name + (s.author_relation ? ' (' + s.author_relation + ')' : '') + '</p>' : ''}
                  </article>
                `).join('')}
              </div>
            </section>
          ` : ''}

          <div class="border-t pt-4 flex gap-2">
            <button onclick="openDownloadModal()" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">‚¨á Baixar Imagem</button>
          </div>
        </div>
      `
      document.getElementById('content').innerHTML = html
    }

    document.getElementById('agreeCheckbox').addEventListener('change', e => {
      document.getElementById('confirmBtn').disabled = !e.target.checked
    })

    function openDownloadModal() {
      document.getElementById('downloadModal').classList.remove('hidden')
    }

    function closeDownloadModal() {
      document.getElementById('downloadModal').classList.add('hidden')
      document.getElementById('agreeCheckbox').checked = false
      document.getElementById('confirmBtn').disabled = true
    }

    function confirmDownload() {
      if (currentPhoto) {
        const link = document.createElement('a')
        link.href = API + '/' + currentPhoto.file_name
        link.download = 'retratos-bonito-' + new Date().getTime() + '.jpg'
        link.click()
        closeDownloadModal()
      }
    }

    load()
  </script>
</body>
</html>
